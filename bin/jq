#!/bin/sh

if [ $# -eq 0 ]; then
	# default to head if no args
	set -- "HEAD"
fi

if [ $# -eq 1 ] && [[ $(git cat-file -t "$1" 2>/dev/null) == "commit" ]]; then
	# commit
	#	parse ticket(s) from commit(s) message(s) and pass
	commit=$(git rev-parse --short "$1")
	commits=($commit)
	# merge commit
	#	add parent commits also
	parents=$(git show -s --format="%p" $commit)
	if [ $(echo $parents | wc -w) -gt 1 ]; then
		echo "commit $commit is a merge commit, looking also at parents:"
		echo "$parents"
		for parent in $parents; do
			commits+=($parent)
		done
	fi
	# parse ticket(s) from commit(s)
	for commit in ${commits[@]}; do
		tickets+=$(git log -1 "$commit" --pretty=%s | grep -o -P '[A-Za-z]+[:-][\d]+')
		tickets+=" "
	done
	# remove trailing (and leading) whitespace
	tickets=$(echo $tickets | xargs)
	if [ -z "$tickets" ]; then
		# ticket(s) not present
		echo 1>&2 "fatal: no tickets found"
		exit 1
	fi
	# concatenate urls
	for ticket in $tickets; do
		query="$query$JiraUrl$ticket "
	done
	start chrome --new-window $query
else
	# query
	#	pass all args
	start chrome --new-window "$JiraUrl$*"
fi
