#!/bin/sh

if [ $# -eq 0 ]; then
	# default to head if no args
	set -- "HEAD"
fi

if [ $# -eq 1 ] && [[ $(git cat-file -t "$1" 2>/dev/null) == "commit" ]]; then
	# commit
	#	parse ticket from commit message and pass
	commit="$1"
	if [ $(git show --summary --format="%P" $commit | wc -w) -gt 1 ]; then
		echo "commit is a merge commit, looking at 2nd parent"
		# merge commit
		#	see 2nd parent
		commit="$commit^2"
	fi
	ticket=$(git log -1 "$commit" --pretty=%s | grep -o -P '[A-Za-z]+[:-][\d]+')
	if [ -z $ticket ]; then
		# ticket not present
		echo 1>&2 "fatal: no ticket found"
		exit 1
	fi
	start chrome --new-window "$JiraUrl$ticket"
else
	# query
	#	pass all args
	start chrome --new-window "$JiraUrl$*"
fi
