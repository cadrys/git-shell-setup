#!/bin/sh
#
#usage: retry <command>
#       [retry=<count>] [delay=<delay>] retry <command>
#
# Retry a command with exponential backoff delay (250 ms).

if [[ "$1" == "-h" ]]; then print-file-comments "$0"; exit; fi

# +---+----------+--------------------+
# | i | delay@i  |        delay@i+1   |
# |---|----------|--------------------|
# | 0 |       0  |  250*(2^0)   250   |
# | 1 |     250  |  250*(2^1)   500   |
# | 2 |     500  |  250*(2^2)  1000   |
# | 3 |    1000  |  250*(2^3)  2000   |
# | 4 |    2000  |  250*(2^4)  4000   |
# | 5 |    4000  |  250*(2^5)  8000   |
# +---+----------+--------------------+

     retry=${retry-5}
     delay=${delay-250} # msecs
delaytotal=0			# secs
# widths for printf
delaywidth=$(wc -c <<< $(($delay * (2**$retry))))
delaywidth=$(($delaywidth>4?$delaywidth:4))
retrywidth=$(wc -c <<< $retry)
# retry
for iretry in $(seq 0 $retry); do
	echo -e -n "${White}"
	printf "retry: %${retrywidth}s" $iretry
	printf ", delay %${delaywidth}s s" $delaytotal
	echo -e "${None}"
	# sec is the smallest denomination for sleep
	sleep "$delaytotal"s
	# run command
	eval "$@"
	# 250 * (2^iretry)
	msec=$(($delay * (2**$iretry)))
	# convert int to float
	sec=$(printf "%03d" "$msec" | sed -E 's,(...)$,.\1,')
	delaytotal="$sec"
done
