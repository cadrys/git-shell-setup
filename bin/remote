#!/bin/sh

#usage: remote
#           [(-l | --log)    [<branch>]]
#           [(-c | --commit) [<commit>]]
#           [(-t | --tree)   [<branch>]]
#
# Browse to remote url or branch's log (commits) or branch's tree
# or a commit.

GerritUrlQuery="$GerritUrl/#/q/"

while true; do
	case "$1" in
		-h ) print-file-comments "$0"; exit ;;
		-l | --log)
			option="log";
			remoteBranch="$2"
			if [[ -z "$remoteBranch" ]]; then
				remoteBranch=$(git remote-branch HEAD 2>/dev/null);
			fi
			break ;;
		-c | --commit)
			option="commit";
			commit=$(git rev-parse --verify ${2-HEAD} 2>/dev/null);
			if [[ -z "$commit" ]]; then
				echo 1>&2 "fatal: unknown commit $2"
				exit 1
			fi
			break ;;
		-t | --tree)
			option="tree";
			remoteBranch="$2"
			if [[ -z "$remoteBranch" ]]; then
				remoteBranch=$(git remote-branch HEAD 2>/dev/null);
			fi
			break ;;
		* )
			if [ ! -z "$1" ]; then
				echo 1>&2 "fatal: unknown option $1"
				exit 1
			fi
			break ;;
	esac
done

if [[ "$option" == "log" ]]; then
	if [[ -z "$remoteBranch" ]]; then
		echo 1>&2 "fatal: remoteBranch required"
		exit 1
	fi
elif [[ "$option" == "commit" ]]; then
	if [[ -z "$commit" ]]; then
		echo 1>&2 "fatal: commit required"
		exit 1
	fi
elif [[ "$option" == "tree" ]]; then
	if [[ -z "$remoteBranch" ]]; then
		echo 1>&2 "fatal: remoteBranch required"
		exit 1
	fi
fi

git config --get-regex remote\..*\.url \
	| cut -d' ' -f2 \
	| \
		while read line;
		do
			if egrep -q '@'"$GerritUrl"':' <<< "$line"; then
				# gerrit
				sed -r '
					s,\.git$,,
					s,^ssh://.+@'"$GerritUrl"':[0-9]+/,,
					s,^,'"$GerritUrlQuery"'project:,
					' <<< "$line"
			elif egrep -q 'amazonaws.com' <<< "$line"; then
				# codecommit
				region=$(sed '
					s,^.*git-codecommit\.,,
					s,\.amazonaws\.com.*,,
					' <<< "$line")
				if [[ -z "$region" ]]; then
					echo 1>&2 "fatal: region required"
					exit 1
				fi
				if [[ "$option" == "log" ]]; then
					urlPart="commits/$remoteBranch"
				elif [[ "$option" == "commit" ]]; then
					urlPart="commit/$commit"
				elif [[ "$option" == "tree" ]]; then
					urlPart="browse/$remoteBranch/--/"
				fi
				sed '
					s,^.*/repos/,https://'"$region"'.console.aws.amazon.com/codecommit/home?region='"$region"'#/repository/,
					s,$,/,
					s,$,'"$urlPart"',
					' <<< "$line"
			else
				# others: github, gitlab, etc.
				# add log, commit, tree specific url part
				if [[ "$option" == "log" ]]; then
					urlPart="/commits/$remoteBranch"
				elif [[ "$option" == "commit" ]]; then
					urlPart="/commit/$commit"
				elif [[ "$option" == "tree" ]]; then
					urlPart="/tree/$remoteBranch"
				fi
				sed '
					s,\.git$,,
					s,^git@,,
					s,^https?://,,
					s,:,/,
					# add url part
					s,$,'"$urlPart"',
					' <<< "$line"
			fi
		done \
	| browse
